CUDA_VISIBLE_DEVICES="6,7" torchrun --nproc_per_node=2 train.py   --train_dataset "ScanNetpp(split='train', ROOT='/workspace/data/scannetpp_processed_cut3r', resolution=224, aug_crop=16)"   --test_dataset "[None]"   --model "AsymmetricMASt3R(
      pos_embed='RoPE100',
      patch_embed_cls='ManyAR_PatchEmbed',
      img_size=(224, 224),
      head_type='dpt_uq',
      output_mode='pts3d',
      depth_mode=('exp', -inf, inf),
      conf_mode=('exp', 1, inf),
      enc_embed_dim=1024,
      enc_depth=24,
      enc_num_heads=16,
      dec_embed_dim=768,
      dec_depth=12,
      dec_num_heads=12
  )"   --pretrained 'checkpoints/DUSt3R_ViTLarge_BaseDecoder_512_dpt.pth'   --train_criterion "ConfLoss(Regr3D(L21, norm_mode='avg_dis'), alpha=0.2)"   --test_criterion  "ConfLoss(Regr3D(L21, norm_mode='avg_dis'), alpha=0.2)"   --batch_size 8 --epochs 1 --save_steps 5000 --warmup_epochs 0 --blr 1e-4   --lambda_evi 1e-3 --lambda_uq 1.0   --output_dir "./output/mast3r_scannetpp_uq_geom_headonly"



  CUDA_VISIBLE_DEVICES="0,1" torchrun --nproc_per_node=2 train.py \
  --train_dataset "ScanNetpp(split='train', ROOT='/workspace/data/scannetpp_processed_cut3r', resolution=224, aug_crop=16)" \
  --test_dataset "[None]" \
  --model "AsymmetricMASt3R(
      pos_embed='RoPE100',
      patch_embed_cls='ManyAR_PatchEmbed',
      img_size=(224,224),
      head_type='dpt_uq_feat',
      output_mode='pts3d',
      depth_mode=('exp', -inf, inf),
      conf_mode=('exp', 1, inf),
      enc_embed_dim=1024,
      enc_depth=24,
      enc_num_heads=16,
      dec_embed_dim=768,
      dec_depth=12,
      dec_num_heads=12
  )" \
  --pretrained 'checkpoints/DUSt3R_ViTLarge_BaseDecoder_512_dpt.pth' \
  --train_criterion "ConfLoss(Regr3D(L21, norm_mode='avg_dis'), alpha=0.2)" \
  --test_criterion  "ConfLoss(Regr3D(L21, norm_mode='avg_dis'), alpha=0.2)" \
  --batch_size 8 --epochs 1 --save_steps 100000 --warmup_epochs 0 --blr 1e-4 \
  --lambda_evi 1e-3 --lambda_uq 1.0 \
  --output_dir "./output/mast3r_scannetpp_uq_feat"





####new training for 3d uq and joint traning method
torchrun --nproc_per_node=6 train.py \
  --train_dataset "ScanNetpp(split='train', ROOT='/workspace/data/scannetpp_processed_cut3r', resolution=224, aug_crop=16)" \
  --test_dataset "[None]" \
  --model "AsymmetricMASt3R(
              pos_embed='RoPE100',
              patch_embed_cls='ManyAR_PatchEmbed',
              img_size=(224, 224),
              head_type='catconv',
              output_mode='pts3d+desc24',
              depth_mode=('exp', -inf, inf),
              conf_mode=('exp', 1, inf),
              enc_embed_dim=1024,
              enc_depth=24,
              enc_num_heads=16,
              dec_embed_dim=768,
              dec_depth=12,
              dec_num_heads=12,
              two_confs=True,
              desc_conf_mode=('exp', 0, inf)
          )" \
  --pretrained "checkpoints/MASt3R_ViTLarge_BaseDecoder_512_catmlpdpt_metric.pth" \
  --train_criterion "ConfLoss(Regr3D(L21, norm_mode='avg_dis'), alpha=0.2)" \
  --test_criterion  "ConfLoss(Regr3D(L21, norm_mode='avg_dis'), alpha=0.2)" \
  --batch_size 10 \
  --epochs 5 \
  --warmup_epochs 0 \
  --save_steps 50000 \
  --blr 3e-4 \
  --lambda_uq 0.0 \
  --lambda_evi_feat 0.0 \
  --lambda_mean_gt 0.0 --lambda_mean_distill 0.0 --lambda_var_distill 0.0 \
  --lambda_uq_xyz 0.2 \
  --lambda_evi_xyz 1e-3 \
  --output_dir "./output/mast3r_scannetpp_catconv_xyzUQ_joint"


âœ… Stage 1ï¼šå†»ç»“å‡ ä½•ï¼Œåªè®­ç»ƒ 3D UQ head

ç‰¹ç‚¹ï¼š

å‡ ä½• + backbone å…¨éƒ¨å†»ç»“ï¼Œåªè§£å†» head_xyz_eviï¼›

loss å®Œå…¨ç”¨ loss_uq_xyzï¼ˆå› ä¸º lambda_uq_xyz=1.0ï¼‰ï¼›

æ—§çš„ depth-UQ å’Œ distill loss å…¨éƒ¨å…³æ‰ã€‚

torchrun --nproc_per_node=6 train.py \
  --train_dataset "ScanNetpp(split='train', ROOT='/workspace/data/scannetpp_processed_cut3r', resolution=224, aug_crop=16)" \
  --test_dataset "[None]" \
  --model "AsymmetricMASt3R(
              pos_embed='RoPE100',
              patch_embed_cls='ManyAR_PatchEmbed',
              img_size=(224, 224),
              head_type='catconv',
              output_mode='pts3d+desc24',
              depth_mode=('exp', -inf, inf),
              conf_mode=('exp', 1, inf),
              enc_embed_dim=1024,
              enc_depth=24,
              enc_num_heads=16,
              dec_embed_dim=768,
              dec_depth=12,
              dec_num_heads=12,
              two_confs=True,
              desc_conf_mode=('exp', 0, inf)
          )" \
  --pretrained "checkpoints/MASt3R_ViTLarge_BaseDecoder_512_catmlpdpt_metric.pth" \
  --train_criterion "ConfLoss(Regr3D(L21, norm_mode='avg_dis'), alpha=0.2)" \
  --test_criterion  "ConfLoss(Regr3D(L21, norm_mode='avg_dis'), alpha=0.2)" \
  --batch_size 10 \
  --epochs 5 \
  --warmup_epochs 0 \
  --save_steps 50000 \
  --blr 3e-4 \
  --uq_mode "geom" \
  --freeze_geom_for_uq \
  --lambda_uq 0.0 \
  --lambda_evi_feat 0.0 \
  --lambda_mean_gt 0.0 \
  --lambda_mean_distill 0.0 \
  --lambda_var_distill 0.0 \
  --lambda_uq_xyz 1.0 \
  --lambda_evi_xyz 1e-3 \
  --output_dir "./output/mast3r_scannetpp_catconv_xyzUQ_stage1_frozenGeom"


è§£é‡Šä½ å¯ä»¥ç›´æ¥è·Ÿè€å¸ˆè¯´ï¼š

â€œStage 1 æˆ‘ä»¬æŠŠ MASt3R çš„å‡ ä½• backbone + pts3d head å…¨éƒ¨å†»ç»“ï¼Œ
åªè®­ç»ƒæŒ‚åœ¨ CatConv token ä¸Šçš„æ–° 3D UQ headï¼ˆhead_xyz_eviï¼‰ï¼›
loss åªç”¨ loss_uq_xyzï¼Œç›¸å½“äºåœ¨ä¸€ä¸ªå›ºå®šå‡ ä½•è¯¯å·®åœºä¸Šæ‹Ÿåˆ 3D NIG ä¸ç¡®å®šæ€§ã€‚â€

âœ… Stage 2ï¼šJoint finetune å‡ ä½• + 3D UQ

ç‰¹ç‚¹ï¼š

ä¸ä¼  --freeze_geom_for_uq â†’ ä¸å† freezeï¼Œå‡ ä½•å’Œ UQ éƒ½å‚ä¸æ›´æ–°ï¼›

å‡ ä½• base loss + UQ loss æ··åˆï¼š

ğ¿
total
=
(
1
âˆ’
ğœ†
uq_xyz
)
ğ¿
geo
+
ğœ†
uq_xyz
ğ¿
UQ-3D
L
total
	â€‹

=(1âˆ’Î»
uq_xyz
	â€‹

)L
geo
	â€‹

+Î»
uq_xyz
	â€‹

L
UQ-3D
	â€‹


ç”¨ä½ åŸæ¥çš„ lambda_uq_xyz=0.2ï¼Œè®©å‡ ä½•è¿˜æ˜¯ä¸»è§’ï¼ŒUQ æ˜¯è¾…åŠ©ã€‚

torchrun --nproc_per_node=6 train.py \
  --train_dataset "ScanNetpp(split='train', ROOT='/workspace/data/scannetpp_processed_cut3r', resolution=224, aug_crop=16)" \
  --test_dataset "[None]" \
  --model "AsymmetricMASt3R(
              pos_embed='RoPE100',
              patch_embed_cls='ManyAR_PatchEmbed',
              img_size=(224, 224),
              head_type='catconv',
              output_mode='pts3d+desc24',
              depth_mode=('exp', -inf, inf),
              conf_mode=('exp', 1, inf),
              enc_embed_dim=1024,
              enc_depth=24,
              enc_num_heads=16,
              dec_embed_dim=768,
              dec_depth=12,
              dec_num_heads=12,
              two_confs=True,
              desc_conf_mode=('exp', 0, inf)
          )" \
  --pretrained "./output/mast3r_scannetpp_catconv_xyzUQ_stage1_frozenGeom/checkpoint-last.pth" \
  --train_criterion "ConfLoss(Regr3D(L21, norm_mode='avg_dis'), alpha=0.2)" \
  --test_criterion  "ConfLoss(Regr3D(L21, norm_mode='avg_dis'), alpha=0.2)" \
  --batch_size 10 \
  --epochs 5 \
  --warmup_epochs 0 \
  --save_steps 50000 \
  --blr 3e-4 \
  --uq_mode "geom" \
  --lambda_uq 0.0 \
  --lambda_evi_feat 0.0 \
  --lambda_mean_gt 0.0 \
  --lambda_mean_distill 0.0 \
  --lambda_var_distill 0.0 \
  --lambda_uq_xyz 0.2 \
  --lambda_evi_xyz 1e-3 \
  --output_dir "./output/mast3r_scannetpp_catconv_xyzUQ_stage2_joint"


è¿™é‡Œæˆ‘è®© Stage 2 çš„ --pretrained ç›´æ¥æ¥ç€ Stage 1 çš„æœ€å checkpointï¼Œä½ ä¹Ÿå¯ä»¥æ¢æˆ checkpoint-step-XXXXXX.pth æŸä¸€æ­¥ã€‚



Stage 1ï¼šå†»ç»“å‡ ä½•ï¼Œåªè®­ 3D UQ å¤´

torchrun --nproc_per_node=6 train.py \
  --train_dataset "ScanNetpp(split='train', ROOT='/workspace/data/scannetpp_processed_cut3r', resolution=224, aug_crop=16)" \
  --test_dataset "[None]" \
  --model "AsymmetricMASt3R(
              pos_embed='RoPE100',
              patch_embed_cls='ManyAR_PatchEmbed',
              img_size=(224, 224),
              head_type='catconv',
              output_mode='pts3d+desc24',
              depth_mode=('exp', -inf, inf),
              conf_mode=('exp', 1, inf),
              enc_embed_dim=1024,
              enc_depth=24,
              enc_num_heads=16,
              dec_embed_dim=768,
              dec_depth=12,
              dec_num_heads=12,
              two_confs=True,
              desc_conf_mode=('exp', 0, inf)
          )" \
  --pretrained "checkpoints/MASt3R_ViTLarge_BaseDecoder_512_catmlpdpt_metric.pth" \
  --train_criterion "ConfLoss(Regr3D(L21, norm_mode='avg_dis'), alpha=0.2)" \
  --test_criterion  "ConfLoss(Regr3D(L21, norm_mode='avg_dis'), alpha=0.2)" \
  --batch_size 10 \
  --epochs 5 \
  --warmup_epochs 0 \
  --save_steps 50000 \
  --blr 3e-4 \
  --lambda_uq 0.0 \
  --lambda_evi_feat 0.0 \
  --lambda_mean_gt 0.0 --lambda_mean_distill 0.0 --lambda_var_distill 0.0 \
  --lambda_uq_xyz 1.0 \
  --lambda_evi_xyz 1e-3 \
  --uq_mode "xyz" \
  --freeze_geom_for_uq \
  --output_dir "./output/mast3r_scannetpp_catconv_xyzUQ_stage1_frozenGeom"


Stage 2ï¼šjoint finetuneï¼ˆå‡ ä½• + 3D UQ ä¸€èµ·è®­ï¼‰

torchrun --nproc_per_node=6 train.py \
  --train_dataset "ScanNetpp(split='train', ROOT='/workspace/data/scannetpp_processed_cut3r', resolution=224, aug_crop=16)" \
  --test_dataset "[None]" \
  --model "AsymmetricMASt3R(...åŒä¸Š...)" \
  --pretrained "./output/mast3r_scannetpp_catconv_xyzUQ_stage1_frozenGeom/checkpoint-last.pth" \
  --train_criterion "ConfLoss(Regr3D(L21, norm_mode='avg_dis'), alpha=0.2)" \
  --test_criterion  "ConfLoss(Regr3D(L21, norm_mode='avg_dis'), alpha=0.2)" \
  --batch_size 10 \
  --epochs 5 \
  --warmup_epochs 0 \
  --save_steps 50000 \
  --blr 3e-4 \
  --lambda_uq 0.0 \
  --lambda_evi_feat 0.0 \
  --lambda_mean_gt 0.0 --lambda_mean_distill 0.0 --lambda_var_distill 0.0 \
  --lambda_uq_xyz 0.2 \
  --lambda_evi_xyz 1e-3 \
  --uq_mode "xyz" \
  --output_dir "./output/mast3r_scannetpp_catconv_xyzUQ_stage2_joint"



  #sanity check for the dataset to see if it's good to train the model
CUDA_VISIBLE_DEVICES=7 python train.py   --train_dataset "ScanNetpp(split='train', ROOT='/workspace/data/scannetpp_processed_cut3r', resolution=224, aug_crop=16)"   --test_dataset  "[None]"   --model "AsymmetricMASt3R(                     
              pos_embed='RoPE100',                                                            
              patch_embed_cls='ManyAR_PatchEmbed',                                            
              img_size=(224, 224),                                                            
              head_type='catconv',                                                            
              output_mode='pts3d+desc24',                                                     
              depth_mode=('exp', -inf, inf),                                                  
              conf_mode=('exp', 1, inf),                                                      
              enc_embed_dim=1024,                                                             
              enc_depth=24,                                                                   
              enc_num_heads=16,                                                               
              dec_embed_dim=768,                                                              
              dec_depth=12,                                                                   
              dec_num_heads=12,                                                               
              two_confs=True,                                                                 
              desc_conf_mode=('exp', 0, inf)                                                  
          )"   --pretrained "checkpoints/MASt3R_ViTLarge_BaseDecoder_512_catmlpdpt_metric.pth"
   --train_criterion "ConfLoss(Regr3D(L21, norm_mode='avg_dis'), alpha=0.2)"   --test_criterio
n  "ConfLoss(Regr3D(L21, norm_mode='avg_dis'), alpha=0.2)"   --batch_size 10   --epochs 5   --
warmup_epochs 0   --save_steps 5000   --blr 3e-4   --lambda_uq 0.0   --lambda_evi_feat 0.0   -
-lambda_mean_gt 0.0   --lambda_mean_distill 0.0   --lambda_var_distill 0.0   --lambda_uq_xyz 0
.0   --lambda_evi_xyz 0.0   --output_dir "./output_new/mast3r_scannetpp_catconv_geom_sanity"