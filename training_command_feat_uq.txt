
Step 1ï¼šè®­ç»ƒ GeoUQ Teacherï¼ˆå‡ ä½• UQï¼‰

ç›®çš„ï¼š
æŠŠ head_type='dpt_uq' è¿™å¥—å‡ ä½• UQ è®­åˆ° depth mean æ¸…æ™°ã€var pattern åˆç†ã€NLL ä¸çˆ†ç‚¸ã€‚è¿™ä¸ª checkpoint åé¢ä¼šç»™ FeatUQ å½“è€å¸ˆç”¨ã€‚

å…¸å‹å‘½ä»¤ï¼ˆä½ å·²ç»å·®ä¸å¤šè·‘è¿‡ï¼‰ï¼š

# GeoUQ teacher
torchrun --nproc_per_node=2 train.py \
  --train_dataset "ScanNetpp(split='train', ROOT='/workspace/data/scannetpp_processed_cut3r', resolution=224, aug_crop=16)" \
  --test_dataset "[None]" \
  --model "AsymmetricMASt3R(patch_embed_cls='ManyAR_PatchEmbed', img_size=(224, 224), head_type='dpt_uq')" \
  --pretrained "checkpoints/DUSt3R_ViTLarge_BaseDecoder_512_dpt.pth" \
  --train_criterion "ConfLoss(Regr3D(L21, norm_mode='avg_dis'), alpha=0.2)" \
  --test_criterion  "ConfLoss(Regr3D(L21, norm_mode='avg_dis'), alpha=0.2)" \
  --batch_size 8 --epochs 20 --blr 1e-4 \
  --uq_mode "geom" \
  --lambda_uq 1.0 --lambda_evi 1e-3 \
  --output_dir "./output/scannetpp_uq_geom_teacher"


å¾—åˆ°çš„ä¸œè¥¿ï¼š

./output/scannetpp_uq_geom_teacher/checkpoint-best.pthï¼ˆæˆ– last.pthï¼‰ï¼š
è¿™é‡Œçš„ DPT + å‡ ä½•å¤´ + GeoUQ å¤´ = è€å¸ˆå‚æ•°ã€‚

è®ºæ–‡é‡Œï¼š

è¿™ä¸ª run = â€œGeoUQ baselineâ€ã€‚

Step 2ï¼šFeatUQ Phase 1 â€”â€” å…ˆæŠŠ feature depth mean å­¦æ¸…æ¥š

ç›®çš„ï¼š
è®© feature çš„ deterministic depth åˆ†æ”¯å…ˆå­¦ä¼šä¸€ä¸ªâ€œæ¸…æ™°çš„æ·±åº¦å›¾â€ï¼Œä¸æ€¥ç€å­¦ varã€‚å¦åˆ™ç›´æ¥ä¸Š NIGï¼Œç»“æœå°±ä¼šåƒä½ ç°åœ¨çœ‹åˆ°çš„é‚£æ ·ä¸€å›¢ç³Šã€‚

æ¨¡å‹ï¼š

ä½¿ç”¨ head_type='dpt_uq_feat'ï¼ˆä½ å·²ç»åœ¨ repo é‡ŒåŠ è¿‡ Option Bï¼‰ï¼›

åˆå§‹åŒ–çš„æ—¶å€™ï¼Œç”¨ Step 1 çš„ teacher checkpoint åš pretrainedï¼š

backbone + DPT + GeoUQ éƒ¨åˆ†åŠ è½½è¿›æ¥ï¼ˆstrict=Falseï¼‰ï¼›

æ–°å¢çš„ feature depth head / evidential head éšæœºåˆå§‹åŒ–ã€‚

è®­ç»ƒç­–ç•¥ï¼š

uq_mode="feat"ï¼Œphase=1ï¼ˆæˆ‘ä»¬åœ¨ training.py é‡ŒåŠ è¿‡è¿™ä¸ª flagï¼‰ï¼›

å†»ç»“ï¼š

encoder + decoder + GeoUQ å…¨éƒ¨ requires_grad=Falseï¼›

åªå¼€ depth_mean_head é‚£å‡ ä¸ªå‚æ•°çš„ gradï¼›

Lossï¼š

åªç”¨ L2(depth_mu_feat, depth_gt) + å¯ä»¥å°‘é‡ L2 å¯¹é½ teacher meanï¼ˆå¯é€‰ï¼‰ã€‚

å‘½ä»¤ç¤ºä¾‹ï¼š

# FeatUQ Phase 1: depth mean only
torchrun --nproc_per_node=2 train.py \
  --train_dataset "ScanNetpp(split='train', ROOT='/workspace/data/scannetpp_processed_cut3r', resolution=224, aug_crop=16)" \
  --test_dataset "[None]" \
  --model "AsymmetricMASt3R(patch_embed_cls='ManyAR_PatchEmbed', img_size=(224, 224), head_type='dpt_uq_feat')" \
  --pretrained "./output/scannetpp_uq_geom_teacher/checkpoint-best.pth" \
  --train_criterion "ConfLoss(Regr3D(L21, norm_mode='avg_dis'), alpha=0.2)" \
  --test_criterion  "ConfLoss(Regr3D(L21, norm_mode='avg_dis'), alpha=0.2)" \
  --batch_size 8 --epochs 5 --blr 1e-4 \
  --uq_mode "feat" --phase 1 \
  --lambda_evi_feat 0.0 \
  --lambda_mean_gt 1.0 --lambda_mean_distill 0.1 --lambda_var_distill 0.0 \
  --output_dir "./output/scannetpp_uq_feat_phase1"


è¿™ä¸€æ­¥ç»“æŸä½ è¦ checkï¼š

ç”¨ viz_uq.py ä¹‹ç±»çš„è„šæœ¬ï¼ŒæŠŠï¼š

depth_mean_feat

å’Œ GeoUQ çš„ depth_mu_geom
çš„å¯è§†åŒ–ç”»å‡ºæ¥ï¼Œæ¯”ä¸€ä¸‹æ¸…æ™°åº¦ã€ç»“æ„ï¼›

æŒ‡æ ‡ä¸Šï¼šfeat depth çš„ RMSE ä¸èƒ½æ¯” GeoUQ å·®å¤ªå¤šã€‚

Step 3ï¼šFeatUQ Phase 2 â€”â€” çœŸæ­£çš„ â€œOursâ€ï¼ˆevidential + è’¸é¦ï¼‰

ç›®çš„ï¼š
åœ¨ Phase 1 çš„åŸºç¡€ä¸Šï¼ŒåŠ  evidential NIG + ä» GeoUQ è€å¸ˆè’¸é¦ mean/var patternï¼Œè¿™ä¸ªé˜¶æ®µè®­ç»ƒå®Œçš„æ¨¡å‹å°±æ˜¯ä½ è®ºæ–‡é‡Œçš„ â€œOursâ€ã€‚

åˆå§‹åŒ–ï¼š

ä» Phase 1 çš„ checkpoint å¼€å§‹ï¼ˆå› ä¸º Phase1 å·²ç»æŠŠ depth_mean_feat è®­å¾—å·®ä¸å¤šäº†ï¼‰ã€‚

è®­ç»ƒç­–ç•¥ï¼š

ä»ç„¶ uq_mode="feat"ï¼Œphase=2ï¼ˆæˆ‘ä»¬åœ¨ freeze å‡½æ•°é‡ŒåŒºåˆ†ï¼‰ï¼›

å†»ç»“ï¼š

backbone + GeoUQ é€šé“ä¾ç„¶ frozenï¼Œåª forwardï¼Œå½“ teacherï¼›

FeatUQ çš„ depth mean + evidential å¤´ä¸¤æ”¯éƒ½ requires_grad=Trueï¼›

Loss ç»„åˆï¼ˆper our designï¼‰ï¼š

ğ¿
evi-feat
L
evi-feat
	â€‹

ï¼šNIG NLL + evidential regï¼ˆç”¨ depth GTï¼‰

ğ¿
mean-gt
L
mean-gt
	â€‹

ï¼šä¿æŒ mean å¯¹é½ GT

ğ¿
mean-distill
L
mean-distill
	â€‹

ï¼šmean å‘ GeoUQ è€å¸ˆé æ‹¢ä¸€ç‚¹

ğ¿
var-distill
L
var-distill
	â€‹

ï¼švar pattern å‘ GeoUQ é æ‹¢ï¼ˆé˜²æ­¢ä¹±é£˜ï¼‰

å‘½ä»¤ç¤ºä¾‹ï¼š

# FeatUQ Phase 2: evidential + distillation (OURS)
torchrun --nproc_per_node=2 train.py \
  --train_dataset "ScanNetpp(split='train', ROOT='/workspace/data/scannetpp_processed_cut3r', resolution=224, aug_crop=16)" \
  --test_dataset "[None]" \
  --model "AsymmetricMASt3R(patch_embed_cls='ManyAR_PatchEmbed', img_size=(224, 224), head_type='dpt_uq_feat')" \
  --pretrained "./output/scannetpp_uq_feat_phase1/checkpoint-last.pth" \
  --train_criterion "ConfLoss(Regr3D(L21, norm_mode='avg_dis'), alpha=0.2)" \
  --test_criterion  "ConfLoss(Regr3D(L21, norm_mode='avg_dis'), alpha=0.2)" \
  --batch_size 8 --epochs 20 --blr 1e-4 \
  --uq_mode "feat" --phase 2 \
  --lambda_evi_feat 0.1 \
  --lambda_mean_gt 1.0 \
  --lambda_mean_distill 1.0 \
  --lambda_var_distill 0.1 \
  --output_dir "./output/scannetpp_uq_feat_phase2_ours"


è®­ç»ƒå®Œä»¥åï¼Œè¿™ä¸ª ...feat_phase2_ours checkpoint å°±æ˜¯ï¼š

â€œOurs (FeatUQ, feature-level evidential UQ distilled from GeoUQ)â€


###############################################################





torchrun --nproc_per_node=2 train.py \
  --train_dataset "ScanNetpp(split='train', ROOT='/workspace/data/scannetpp_processed_cut3r', resolution=224, aug_crop=16)" \
  --test_dataset "[None]" \
  --model "AsymmetricMASt3R(
      pos_embed='RoPE100',
      patch_embed_cls='ManyAR_PatchEmbed',
      img_size=(224, 224),
      head_type='dpt_uq_feat',
      output_mode='pts3d',
      depth_mode=('exp', -inf, inf),
      conf_mode=('exp', 1, inf),
      enc_embed_dim=1024,
      enc_depth=24,
      enc_num_heads=16,
      dec_embed_dim=768,
      dec_depth=12,
      dec_num_heads=12
  )" \
  --pretrained "./output/mast3r_scannetpp_uq_geom_headonly/checkpoint-step-850000.pth" \
  --train_criterion "ConfLoss(Regr3D(L21, norm_mode='avg_dis'), alpha=0.2)" \
  --test_criterion  "ConfLoss(Regr3D(L21, norm_mode='avg_dis'), alpha=0.2)" \
  --batch_size 64 --epochs 1 --blr 1e-4 \
  --uq_mode "feat" --phase 1 \
  --lambda_evi_feat 0.0 \
  --save_steps 20000 \
  --lambda_mean_gt 1.0 --lambda_mean_distill 0.1 --lambda_var_distill 0.0 \
  --output_dir "./output/mast3r_scannetpp_uq_feat_phase1"



torchrun --nproc_per_node=2 train.py \
  --train_dataset "ScanNetpp(split='train', ROOT='/workspace/data/scannetpp_processed_cut3r', resolution=224, aug_crop=16)" \
  --test_dataset "[None]" \
  --model "AsymmetricMASt3R(
      pos_embed='RoPE100',
      patch_embed_cls='ManyAR_PatchEmbed',
      img_size=(224, 224),
      head_type='dpt_uq_feat',
      output_mode='pts3d',
      depth_mode=('exp', -inf, inf),
      conf_mode=('exp', 1, inf),
      enc_embed_dim=1024,
      enc_depth=24,
      enc_num_heads=16,
      dec_embed_dim=768,
      dec_depth=12,
      dec_num_heads=12
  )" \
  --pretrained "./output/mast3r_scannetpp_uq_feat_phase1/checkpoint-last.pth" \
  --train_criterion "ConfLoss(Regr3D(L21, norm_mode='avg_dis'), alpha=0.2)" \
  --test_criterion  "ConfLoss(Regr3D(L21, norm_mode='avg_dis'), alpha=0.2)" \
  --batch_size 64 --epochs 1 --blr 1e-4 \
  --uq_mode "feat" --phase 2 \
  --lambda_evi_feat 0.1 \
  --lambda_mean_gt 1.0 \
  --save_steps 20000 \
  --lambda_mean_distill 1.0 \
  --lambda_var_distill 0.1 \
  --output_dir "./output/mast3r_scannetpp_uq_feat_phase2"







new command 

torchrun --nproc_per_node=6 train.py \
  --train_dataset "ScanNetpp(split='train', ROOT='/workspace/data/scannetpp_processed_cut3r', resolution=224, aug_crop=16)" \
  --test_dataset "[None]" \
  --model "AsymmetricMASt3R(pos_embed='RoPE100', patch_embed_cls='ManyAR_PatchEmbed', img_size=(224, 224), head_type='dpt_uq_feat', output_mode='pts3d', depth_mode=('exp', -inf, inf), conf_mode=('exp', 1, inf), enc_embed_dim=1024, enc_depth=24, enc_num_heads=16, dec_embed_dim=768, dec_depth=12, dec_num_heads=12)" \
  --pretrained "./output/mast3r_scannetpp_uq_geom_headonly/checkpoint-step-850000.pth" \
  --train_criterion "ConfLoss(Regr3D(L21, norm_mode='avg_dis'), alpha=0.2)" \
  --test_criterion  "ConfLoss(Regr3D(L21, norm_mode='avg_dis'), alpha=0.2)" \
  --batch_size 10 \
  --epochs 5 \
  --blr 3e-4 \
  --warmup_epochs 1 \
  --uq_mode "feat" --phase 1 \
  --lambda_evi_feat 0.0 \
  --lambda_mean_gt 1.0 --lambda_mean_distill 0.1 --lambda_var_distill 0.0 \
  --save_steps 20000 \
  --output_dir "./output/mast3r_scannetpp_uq_feat_phase1_fast"


torchrun --nproc_per_node=6 --master_port=29600 train.py \
  --train_dataset "ScanNetpp(split='train', ROOT='/workspace/data/scannetpp_processed_cut3r', resolution=224, aug_crop=16)" \
  --test_dataset "[None]" \
  --model "AsymmetricMASt3R(
      pos_embed='RoPE100',
      patch_embed_cls='ManyAR_PatchEmbed',
      img_size=(224, 224),
      head_type='dpt_uq_feat',
      output_mode='pts3d',
      depth_mode=('exp', -inf, inf),
      conf_mode=('exp', 1, inf),
      enc_embed_dim=1024,
      enc_depth=24,
      enc_num_heads=16,
      dec_embed_dim=768,
      dec_depth=12,
      dec_num_heads=12
  )" \
  --pretrained "./output/mast3r_scannetpp_uq_feat_phase1_fast_temp1/checkpoint-last.pth" \
  --train_criterion "ConfLoss(Regr3D(L21, norm_mode='avg_dis'), alpha=0.2)" \
  --test_criterion  "ConfLoss(Regr3D(L21, norm_mode='avg_dis'), alpha=0.2)" \
  --batch_size 10 --epochs 5 --blr 1e-4  --warmup_epochs 1 \
  --uq_mode "feat" --phase 2 \
  --lambda_evi_feat 0.1 \
  --lambda_mean_gt 1.0 \
  --save_steps 20000 \
  --lambda_mean_distill 1.0 \
  --lambda_var_distill 0.1 \
  --output_dir "./output/mast3r_scannetpp_uq_feat_phase2_fast"

#for new run with correct distillation from geom headï¼Œ with bigger distillation weight, learn more from teacher
  torchrun --nproc_per_node=6 train.py \
  --train_dataset "ScanNetpp(split='train', ROOT='/workspace/data/scannetpp_processed_cut3r', resolution=224, aug_crop=16)" \
  --test_dataset "[None]" \
  --model "AsymmetricMASt3R(pos_embed='RoPE100', patch_embed_cls='ManyAR_PatchEmbed', img_size=(224, 224), head_type='dpt_uq_feat', output_mode='pts3d', depth_mode=('exp', -inf, inf), conf_mode=('exp', 1, inf), enc_embed_dim=1024, enc_depth=24, enc_num_heads=16, dec_embed_dim=768, dec_depth=12, dec_num_heads=12)" \
  --pretrained "./output/mast3r_scannetpp_uq_feat_phase1_fast_temp1/checkpoint-last.pth" \
  --train_criterion "ConfLoss(Regr3D(L21, norm_mode='avg_dis'), alpha=0.2)" \
  --test_criterion  "ConfLoss(Regr3D(L21, norm_mode='avg_dis'), alpha=0.2)" \
  --batch_size 10 \
  --epochs 5 \
  --blr 3e-4 \
  --warmup_epochs 1 \
  --uq_mode "feat" --phase 1 \
  --lambda_evi_feat 0.0 \
  --lambda_mean_gt 0.5 --lambda_mean_distill 1.0 --lambda_var_distill 0.0 \
  --save_steps 20000 \
  --output_dir "./output/mast3r_scannetpp_uq_feat_phase1_fast_temp"

 #run it with more epoch, 5 epoch
torchrun --nproc_per_node=6 train.py   --train_dataset "ScanNetpp(split='train', ROOT='/workspace/data/scannetpp_processed_cut3r', resolution=224, aug_crop=16)"   --test_dataset "[None]"   --model "AsymmetricMASt3R(pos_embed='RoPE100', patch_embed_cls='ManyAR_PatchEmbed', img_size=(224, 224), head_type='dpt_uq_feat', output_mode='pts3d', depth_mode=('exp', -inf, inf), conf_mode=('exp', 1, inf), enc_embed_dim=1024, enc_depth=24, enc_num_heads=16, dec_embed_dim=768, dec_depth=12, dec_num_heads=12)"   --pretrained "./output/mast3r_scannetpp_uq_geom_headonly/checkpoint-step-850000.pth"   --train_criterion "ConfLoss(Regr3D(L21, norm_mode='avg_dis'), alpha=0.2)"   --test_criterion  "ConfLoss(Regr3D(L21, norm_mode='avg_dis'), alpha=0.2)"   --batch_size 10   --epochs 5   --blr 3e-4   --warmup_epochs 1   --uq_mode "feat" --phase 1   --lambda_evi_feat 0.0   --lambda_mean_gt 0.5 --lambda_mean_distill 1.0 --lambda_var_distill 0.0   --save_steps 20000   --output_dir "./output/mast3r_scannetpp_uq_feat_phase1_fast_temp1"